# Тестирование `ButtonComponent`

Тестирование нашего компонента позволит удостовериться, что он работает корректно в данный момент и продолжает корректно работать при внесении правок, рефакторинге и (вдруг) добавлении нового функционала.

В первом проекте мы реализовывали интеграционные тесты с помощью `Playwright`. Мы можем написать аналогичные e2e-тесты для `ButtonComponent`. Однако, так как здесь мы расширяли встроенный элемент стилями, не добавляя функционал, логичнее будет провести визуальную регрессию.

## Визуальная регрессия со Storybook и Playwright

Задача визуальной регрессии - проверить, не изменилось ли представление (разметка) и/или визуальное отображение элемента.

Мы будем выполнять ее также средствами *Playwright*, и напишем два типа тестов: снэпшот- и скриншот-тесты.

`Playwright` уже добавлен в репозиторий и готов к запуску тестов из директории `tests`. В тестах мы будем обращаться по адресу, на котором запущен `Storybook`. Стори отображаются в элементах `<iframe>` и нам важно верно обратиться к ним.

Путь к основной стори компонента выглядит так: `http://localhost:6006/?path=/story/components-button--primary`. Кликом по элементу интерфейса в правом верхнем углу скопируем ссылку на изолированный `<iframe>`, где не будет ничего лишнего: `http://localhost:6006/iframe.html?globals=&args=&id=components-button--primary`. Его и будем использовать для тестов.

Для запуска `Playwright` в визуальном режиме будем использовать команду: `npm run test:e2e:ui`

## Снэпшот-тестирование

Снэпшот-тесты проверяют визуальное отображение компонентов. Они берут свежий слепок разметки и сравнивают его с предыдущим состоянием.

```ts
// tests/Button.spec.ts

test('component should match snapshot', async ({ page }) => {
  await page.goto('iframe.html?globals=&args=&id=components-button--primary');
  const root = page.locator('#storybook-root button')
  const innerHTML = (await root.innerHTML()).replace(/<\!--.*?-->/g, "");
  expect(innerHTML).toMatchSnapshot()
});
```

При первом запуске тесты дадут ошибку, т.к. снэпшоты еще не сняты. По умолчанию они помещаются в `tests`, в отдельную директорию. При следующем запуске произойдет сравнение разметки с сохраненной.

## Скриншот-тестирование

Бывает, что нам не так важно сохранение внутреннего наполнения элемента, как то, чтобы он не потерял свой существующий внешний вид. Для этого используются скриншот-тесты.

```ts
// tests/Button.spec.ts

test('component should match screenshot', async ({ page }) => {
  await page.goto('/iframe.html?globals=&args=&id=components-button--primary');
  await expect(page).toHaveScreenshot()
});
```

Как и в предыдущем случае, при первом запуске скриншоты будут сгенерированы, и уже при последующем - проверены.

Зачастую, когда верстка или стилизация еще не утверждена, ошибки снэпшот- и скриншот-тестов бывают навязчивы. Более того, если изменения были сделаны сознательно, нам нужно вручную сообщать, что именно новую версию стоит считать за образец.

Для этого можно либо вручную удалить снэпшоты и скриншоты (они находятся в одной и той же директории), либо использовать `npx playwright test -u` для их обновления.

В любом случае, логично приступать к таким способам визуального тестирования тогда, когда общие черты элемента уже намечены и регулярных изменений не планируется.
